# Руководство для Ubuntu 22.04 LTS

> Как настроить сеть в Ubuntu 22.04 LTS при помощи Netplan

Стоит заметить, что именафайлов конфигурации обычно содержат в начале двузначный цифровой индекс, после которого через дефис идёт "говорящее" название назначения конфига и в онце суффикс `.yaml`. По умолчанию при установке система создаёт что-то вроде `00-installer-config.yaml`, или `01-network-manager-all.yaml`, или что-то в таком духе. Этот нюанс стоит учитывать при попытке написать скрипт автоматизации. Хорошей практикой будет настрока каждого интерфейса в отдельном файле. Цифровой код будет означать в каком порядке будет прочитан данный файл.

## Подготовка

Прежде чем браться за написание YAML, нужно понимать **что мы собираемся настраивать**. Для этого проверяем какие интерфейсы есть у нас командой `ip a`. Не будем обращать внимания на петлевой интерфейс, но вот на "проводные" и "воздушные" соединения мы обратим внимание. Нынче интерфейсы имеют в своём названии не менее пяти букв и первые начинаются с `e`, а вторые - с `w`. Лучше точно записать их на листе бумаги, чтобы не допускать досадных ошибок и не терять время на поиски логических ошибок, там, где имеет место лишь банальная невнимательность.

Поэтому полезно выписать какой у каждого интерфейса IP на данный момент, какое назначение мы ему отводим и какой физический порт соответствует тому или иному интерфейсу. Я бы посоветовал выписать ещё и MAC, потому что бывают иногда руководства, а стало быть имеют место резоны, когда прописывать и этот адрес нужно в конфиге. Но пока ограничимся IP, назначением и портом.

Далее смотрим, точное имя файла и командой `cat` ознакамливаемся с его содержимым. Созданный по умолчанию, этот файл может быть прост как указанный вовступлении к разбору данной утилиты. Но может быть и несколько сложнее, так как во время установки мы могли задать статический IP. В таком случае было бы неплохо забэкапить куда-нибудь имеющийся работающий файл.

## Пара слов о написании

При статической настройке одного интерфейса достаточно указать имя этого устройства, использовать ли DHCP, какой IP мы ему назначаем, настройки DNS и шлюза по умолчанию. Причём с последним нужно прилепить к имени поля без пробелов до двоеточия номер IP протокола, который мы указываем, то есть написать `gateway4:`.

```yaml
network:
  renderer: NetworkManager
  ethernets:
    enp0s3:
      addresses:
        - 192.168.1.102/24
      gateway4: 192.168.1.1
      nameservers:
        addresses:
          - 192.168.1.102
          - 8.8.8.8
          - 8.8.4.4
        search: []
  version: 2
```

Не стану тут расписывать правила работы с YAML. А сейчас не стану давать разъяснения для статики - это очень растянет текст, а дальше будут штучки повкуснее. К тому же если мы настраиваем реальное устроство, то скорее всего одним интерфейсом мы не обойдёмся, а при двух нужно учесть неоторые тонкости со шлюзом. На виртуальных серверах я вообще <span style="color: red;">не советую настраивать сеть через консоль</span>, по той простой причине, что если мы допустим какой-либо просчёт, то машинку придётся терминировать, так как добиваться чего-то от поддержки - выйдет скорее всего дольше, чем поднять новую и учтя ошибки всё перенастроить.

## Проверка и применение конфигов

От суперпользователя выполняем следующие команды:

```shell
# Как умненькие мальчики, ищем броду перед лазанием в воду
sudo netplan try
## Читаем все варнинги, нотайсы и эрроры - благодаря ним мы можем
# оживить и/или вылечить нашу конфигурацию

## ----------------

## Если мы уверены во всём, то ...
# Однако как вариант, если мы пишем на bash, то
# возможно это будет вернее - пробовать нужно при отладке скрипта
sudo netplan apply
```

Например в связи с применением написанной выше конфигурации возникают следующие варнинги:

```shell
** (generate:112573): WARNING **: 13:56:52.137: `gateway4` has been deprecated, use default routes instead.
See the 'Default routes' section of the documentation for more details.
# и так пять раз
```

Конфигурация будет работать, но есть продвигаемые разработчиками более ловкие методы работы с сетью. Скоро эти способы рассмотрим.

<!-- Также следует перезагрузить бекэнд-сервисы сети. В зависимости от того, что там у нас, одна из двух команд нам подойдёт:

```shell
sudo systemctl restart network-manager
sudo systemctl restart system-networkd
``` -->

Проверяем состояние интерфейсов командой `ip a`
