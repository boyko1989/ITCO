# Работа с сервисами

У нас установлен Proxmox, который имеет внешнее хранилище для виртуальных машин на NAS сервере на OpenMediaVault. Первое, что нужно обдумать сейчас - это как воспроизводить конфигурацию и бэкапить данные. Можно использовать и Proxmox Backup Server, но у меня нет отдельного сервера для этого. Так вышло, что у меня уже появились некоторые настроенные машины. Поэтому поэкспериментирую с бэкапом серверов на дополнительное устройство.

## Настрока NFS

Система NFS (Network File System) служит для доступа к информации, содержащейся на дисках других компьютеров.

В OpenMediaVault я перехожу в **Хранилище** -> **Диски** и проверяю то, какие накопители подключены. Затем, здесь же в **Хранилище** в **Файловых системах** и `монтируем` новое хранилище. В качестве тегов добавляем назначение. Сохраняем и принимаем изменения конфигурации (такая особенность OpenMediaVault).

В **Общих каталогах** создаём имя будущего каталога (слово без пробелов). Затем выбираем нужную файловую систему - ту, которую мы создали. Затем даём права доступа и задаём тэги. И точно также: охраняем и принимаем изменения конфигурации.

Затем, в Proxmox мы создаём новое хранилище. В настройках **Datacenter / Storage** выбираем `Add` прописываем:

- **ID**: имя, по  которому будет идентифицироваться хранилище.
- **Server**: IP-адрес или домен сервера с NFS
- **Export**: сюда автоматически подгружаются общие каталоги, в том числе (если мы сохранили **и** настройки, **и** конфигурации)
- **Content**: здесь мы выбираем тип контента, который мы будем там сохранять. Можно выбрать несколько.

Этого пока достаточно. После сохранения мы увидим новое хранилище в списке.

## Бэкапы виртуальных машин

Прежде, чем говорить о резервном копировании, стоит рассмотреть вопрос восстановления и причин почему может потребоваться это восстановление. Хотелось бы, чтобы восстановление происходило путём введения одной-двух команд. Пока в России недоступны сервисы HashiCorp, нужно придумывать какие-то свои костыли. Можно настроить VPN, и я это обязательно сделаю, но попробую обойтись без всяких Terraform или Packet.

Диски виртуальных машин у меня расположены в хранилище `vm-strg`. Именно с удалённого хранилища у меня работают все установленные машины. Однако я собираюсь переделать всё и убрать все машины на время в другое харнилище. Я подцепил новое хранилище и скинул туда все бэкапы имеющихся машин. Это всё срабатывает очень даже хорошо, поэтому будем считать, что бэкапы готовы. Кстати, восстанавливать их можно под любыми свободными ID-шниками.

## Изменение концепции машин

Действующая концепция меня не устраивает прежде всего тем, что она крайне непоследовательна. Но чтобы она была последовательной нужно, чтобы было представление о том, какая архитектура должна быть поднята.

Во-первых, я хочу развернуть локальный домен `*.km468` и все машины и устройства в таком случае будут иметь свои имена в рамках этого домена и обращаться друг ко другу по именам.

Во-вторых, будет установлен прокси-сервер. В качестве данного сервиса будет использоваться `Nginx Proxy`. Этот сервис нужен скорее для доступа извне к нужной машине. DNS-сервер же, о котором я говорил ранее, нужен для внутрисетевых нужд.

### Удаление виртуальных машин

```shell
ls -la /etc/pve/lxc/
ls -la /etc/pve/qemu-server/

pct rescan && qm rescan
```

```shell
Filesystem                      Size  Used Avail Use% Mounted on
udev                             20G     0   20G   0% /dev
tmpfs                           4.0G  1.3M  4.0G   1% /run
/dev/mapper/pve-root             19G  2.8G   15G  17% /
tmpfs                            20G   46M   20G   1% /dev/shm
tmpfs                           5.0M     0  5.0M   0% /run/lock
/dev/fuse                       128M   20K  128M   1% /etc/pve
192.168.0.200:/export/New_strg   72G  4.5G   64G   7% /mnt/pve/backup
192.168.0.200:/export/vm-strg   1.8T  256K  1.8T   1% /mnt/pve/vm-strg
tmpfs                           4.0G     0  4.0G   0% /run/user/0
```

## Таблица распределения индексов вируальных машин

ID pull | Appointment
:--:|:--
| | ***Linux***
`1100 .. 1199` | *Сервисные машины*
`1200 .. 1299` | *Прикладные машины*
`1300 .. 1399` | *Тестовые машины*
`1400 .. 1499` | *Машины для разработки*
`1500 .. 1599` | *Изучение ОС*
| | ***BSD***
`2100 .. 2199` | *Сервисные машины*
`2200 .. 2299` | *Прикладные машины*
`2300 .. 2399` | *Тестовые машины*
`2400 .. 2499` | *Машины для разработки*
`2500 .. 2599` | *Изучение ОС*
| | ***Windows***
`2100 .. 2199` | *Сервисные машины*
`2200 .. 2299` | *Прикладные машины*
`2300 .. 2399` | *Тестовые машины*
`2400 .. 2499` | *Машины для разработки*
`2500 .. 2599` | *Изучение ОС*
| | ***Templates***
`9100 .. 9149` | *Linux.iso*
`9150 .. 9199` | *Linux Cloud-init*
`9200 .. 9249` | *BSD.iso*
`9250 .. 9299` | *BSD Cloud-init*
`9300 .. 9349` | *Windows.iso*
`9350 .. 9399` | *Windows Cloud-init*


## Таблица распределения доменных имён для внутренней сети


